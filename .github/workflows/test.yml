name: Test Docker Builds

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test-flutter:
    name: Test Flutter Environment
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build Flutter image
      run: |
        cd flutter
        docker build -t claude-flutter .

    - name: Test Flutter installation
      run: |
        docker run --rm --entrypoint /bin/bash claude-flutter -c "
          set -e
          echo 'Testing Flutter installation...'
          flutter --version
          echo '---'
          echo 'Testing Dart installation...'
          dart --version
          echo '---'
          echo 'Testing Node.js installation...'
          node --version
          npm --version
          echo '---'
          echo 'Testing Claude Code installation...'
          claude --version
          echo '---'
          echo 'Testing Git installation...'
          git --version
          echo '---'
          echo 'Testing entrypoint script exists...'
          test -x /entrypoint.sh && echo 'entrypoint.sh is executable'
          echo '---'
          echo 'Testing Flutter permissions...'
          flutter doctor --version
          echo '---'
          echo 'All tests passed!'
        "

    - name: Test entrypoint validation
      run: |
        docker run --rm claude-flutter 2>&1 | grep -q "REPO_URL environment variable is required" && echo "Entrypoint validation works"
